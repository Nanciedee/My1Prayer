<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morning Reflection</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Delius&display=swap" rel="stylesheet">
    <!-- New font for the reminder text -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #4169E1; /* Royal Blue */
        }
        textarea {
            resize: vertical; /* Allow vertical resizing */
            min-height: 80px; /* Minimum height for text areas */
            background-color: #FFFACD; /* Pale Yellow background for text areas */
        }
        /* Style for the scripture text to give it a distinct look */
        .scripture-text {
            font-family: 'Delius', serif; /* A classic, elegant font */
            font-size: 1.25rem; /* Larger text */
            font-weight: 600; /* Semi-bold */
            font-style: italic;
            color: #3b5d46; /* A deep green for a natural feel */
            line-height: 1.6;
            text-align: center;
            margin-bottom: 0.5rem;
        }
        .scripture-reference {
            font-size: 0.9rem;
            color: #6c757d;
            text-align: center;
            font-style: italic;
        }
        /* Custom styling for emoji buttons */
        .emoji-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px; /* Fixed width for consistent grid */
            height: 48px; /* Fixed height for consistent grid */
        }
        /* Custom styling for action step buttons */
        .action-step-button {
            padding: 0.5rem 1rem;
            border-radius: 9999px; /* Pill shape */
            border: 2px solid;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease-in-out;
            white-space: nowrap; /* Prevent text from wrapping inside button */
        }
        /* Default unselected state */
        .action-step-button:not(.selected) {
            background-color: #e5e7eb; /* Light gray for unselected */
            border-color: #d1d5db; /* Gray border */
            color: #4b5563; /* Dark gray text */
        }
        .action-step-button:hover:not(.selected) {
            background-color: #d1d5db;
        }

        /* Specific colors for selected states */
        .action-step-button.color-scheme-0 {
            background-color: #a7f3d0; /* Light Green */
            border-color: #10b981; /* Green-600 */
            color: #065f46; /* Green-800 */
        }
        .action-step-button.color-scheme-1 {
            background-color: #bfdbfe; /* Light Blue */
            border-color: #3b82f6; /* Blue-600 */
            color: #1e40af; /* Blue-800 */
        }
        .action-step-button.color-scheme-2 {
            background-color: #fecaca; /* Light Red */
            border-color: #ef4444; /* Red-600 */
            color: #991b1b; /* Red-800 */
        }
        .action-step-button.color-scheme-3 {
            background-color: #fde68a; /* Light Yellow */
            border-color: #f59e0b; /* Yellow-600 */
            color: #92400e; /* Yellow-800 */
        }
        .action-step-button.color-scheme-4 {
            background-color: #e9d5ff; /* Light Purple */
            border-color: #a855f7; /* Purple-600 */
            color: #6b21a8; /* Purple-800 */
        }

        /* Canvas styling */
        #drawingCanvas {
            border: 1px solid #d1d5db;
            background-color: #ffffff;
            cursor: crosshair;
            touch-action: none; /* Prevent browser default touch actions */
        }
        /* Styling for SVG icons within buttons */
        .preset-icon-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px; /* Fixed size for consistency */
            height: 48px;
            border-radius: 0.375rem; /* rounded-md */
            border: 2px solid #d1d5db; /* border-gray-300 */
            background-color: #f9fafb; /* bg-gray-50 */
            transition: all 0.15s ease-in-out;
            cursor: pointer;
        }
        .preset-icon-button:hover {
            background-color: #e5e7eb; /* hover:bg-gray-200 */
        }
        .preset-icon-button.selected {
            background-color: #bfdbfe; /* Light blue background for selected button */
            border-color: #3b82f6; /* Blue border for selected button */
        }
        .preset-icon-button svg {
            width: 80%; /* Make SVG fill the button, slightly smaller */
            height: 80%;
            /* SVG fill colors are now defined directly within the SVG paths */
        }

        /* New style for the reminder text */
        .reminder-text {
            font-family: 'Playfair Display', serif; /* Elegant font */
            font-weight: 700; /* Bold */
            font-style: italic; /* Italic for refinement */
            color: #4b5563; /* Dark gray for visibility against pale yellow box */
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-gradient-to-br from-blue-100 to-purple-100 p-8 rounded-lg shadow-xl max-w-2xl w-full space-y-6 border border-gray-200" id="main-content">
        <h1 class="text-4xl font-extrabold text-center text-gray-800 mb-6" id="main-title">üåÖ Morning Reflection</h1>

        <!-- Language Toggle Buttons -->
        <div class="flex justify-end space-x-2 mb-4">
            <button id="lang-en" class="px-4 py-2 rounded-md bg-blue-500 text-white font-semibold hover:bg-blue-600 transition duration-200">English</button>
            <button id="lang-fr" class="px-4 py-2 rounded-md bg-gray-300 text-gray-800 font-semibold hover:bg-gray-400 transition duration-200">Fran√ßais</button>
        </div>

        <!-- Reminder Section - Content will be updated by JavaScript -->
        <div class="text-center mb-4">
            <p class="text-2xl md:text-3xl reminder-text" id="daily-reminder">You are not walking alone. God is lighting the path, even when it curves.</p>
        </div>

        <!-- Date Navigation and Save Button -->
        <div class="flex items-center justify-between bg-gray-100 p-2 rounded-md shadow-sm border border-gray-200">
            <button id="prev-day-btn" class="px-2 py-0.5 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition duration-200 font-semibold text-sm">&lt; Prev Day</button>
            <span id="current-date-display" class="font-bold text-base text-gray-700"></span>
            <button id="next-day-btn" class="px-2 py-0.5 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition duration-200 font-semibold text-sm">Next Day &gt;</button>
            <button id="save-entry-btn" class="ml-3 px-3 py-1.5 bg-green-500 text-white rounded-md hover:bg-green-600 transition duration-200 font-semibold text-sm">Save Entry</button>
        </div>
        <div id="save-status-message" class="text-center text-sm mt-2 text-gray-600"></div>


        <!-- Scripture of the Day Section -->
        <div class="space-y-2">
            <h2 class="text-2xl font-semibold text-gray-700 flex items-center">
                <span class="text-yellow-500 mr-2">üìñ</span> <span id="scripture-title">Scripture of the Day</span>
            </h2>
            <div class="bg-gray-50 p-4 rounded-md border border-gray-200">
                <p class="scripture-text" id="scripture-text"></p>
                <p class="scripture-reference" id="scripture-reference"></p>
            </div>
        </div>

        <!-- Verse Reflection Section -->
        <div class="space-y-2">
            <h2 class="text-2xl font-semibold text-gray-700 flex items-center">
                <span class="text-yellow-500 mr-2">‚ú®</span> <span id="verse-reflection-title">What does this verse mean to me today?</span>
            </h2>
            <textarea
                class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200 ease-in-out shadow-sm"
                id="verse-reflection-textarea"
                placeholder="Write your thoughts here"
            ></textarea>
        </div>

        <!-- Personal Prayer Section -->
        <div class="space-y-2">
            <h2 class="text-2xl font-semibold text-gray-700 flex items-center">
                <span class="text-purple-500 mr-2">üôè</span> <span id="personal-prayer-title">Personal Prayer</span>
            </h2>
            <p class="text-gray-600 text-sm" id="personal-prayer-subtitle">Talk to God about your hopes and needs today. Here's a suggestion to inspire you:</p>
            <textarea
                class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200 ease-in-out shadow-sm"
                id="prayer-textarea"
                placeholder="Heavenly Father, on this Monday, I come before You seeking strength and guidance. Help me to trust in Your wisdom completely, even when I don't understand Your plan. Guide my steps today and make my path straight according to Your will. Amen."
            ></textarea>
        </div>

        <!-- Spiritual Challenge Section - Placeholder will be updated by JavaScript -->
        <div class="space-y-2">
            <h2 class="text-2xl font-semibold text-gray-700 flex items-center">
                <span class="text-green-500 mr-2">üå±</span> <span id="spiritual-challenge-full-title">Spiritual Challenge of the Day: Trust</span>
            </h2>
            <p class="text-gray-600 text-sm" id="challenge-prompt">Where am I being called to trust God more fully today?</p>
            <textarea
                class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200 ease-in-out shadow-sm"
                id="spiritual-challenge-textarea"
                placeholder="Reflect and write here"
            ></textarea>
        </div>

        <!-- Gratitude Prompt Section - Placeholder will be updated by JavaScript -->
        <div class="space-y-2">
            <h2 class="text-2xl font-semibold text-gray-700 flex items-center">
                <span class="text-pink-500 mr-2">üíõ</span> <span id="gratitude-title">Gratitude Prompt</span>
            </h2>
            <p class="text-gray-600 text-sm" id="gratitude-subtitle">Today, I am thankful for...</p>

            <!-- Emoji Picker for Gratitude -->
            <p class="text-gray-600 text-sm mb-2" id="emoji-instructions">Choose up to 4 emojis that represent your gratitude today:</p>
            <div id="emoji-picker-container" class="grid grid-cols-5 gap-2 justify-items-center p-2 bg-gray-50 rounded-md border border-gray-200">
                <!-- Emojis will be dynamically inserted here by JavaScript -->
            </div>
            <div id="selected-emojis-display" class="mt-2 text-3xl text-center">
                <!-- Selected emojis will appear here -->
            </div>

            <textarea
                class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200 ease-in-out shadow-sm"
                id="gratitude-textarea"
                placeholder="Write your list here"
            ></textarea>
        </div>

        <!-- Action Step Section - New interactive picker -->
        <div class="space-y-2">
            <h2 class="text-2xl font-semibold text-gray-700 flex items-center">
                <span class="text-red-500 mr-2">üìå</span> <span id="action-step-title">Action Step</span>
            </h2>
            <p class="text-gray-600 text-sm" id="action-step-subtitle">One way I will live out today‚Äôs verse is...</p>

            <p class="text-gray-600 text-sm mb-2" id="action-instructions">Choose up to 4 action steps to focus on today:</p>
            <div id="action-step-picker-container" class="flex flex-wrap gap-2 justify-center p-2 bg-gray-50 rounded-md border border-gray-200">
                <!-- Action steps will be dynamically inserted here by JavaScript -->
            </div>
            <div id="selected-action-steps-display" class="mt-2 text-base text-center font-medium text-gray-700">
                <!-- Selected action steps will appear here -->
            </div>

            <textarea
                class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200 ease-in-out shadow-sm"
                id="action-step-textarea"
                placeholder="Elaborate on your chosen action steps or write your own here."
            ></textarea>
        </div>

        <!-- Visual Space Section -->
        <div class="space-y-2">
            <h2 class="text-2xl font-semibold text-gray-700 flex items-center">
                <span class="text-blue-500 mr-2">üñº</span> <span id="visual-space-title">Visual Space</span>
            </h2>
            <p class="text-gray-600 text-sm" id="visual-space-subtitle">Sketch, doodle, or paste an image that reflects your morning inspiration.</p>

            <div class="flex flex-col md:flex-row gap-4">
                <!-- Drawing Controls -->
                <div class="flex flex-col p-3 bg-gray-50 rounded-md border border-gray-200 flex-grow">
                    <p class="text-gray-600 text-sm mb-2" id="drawing-tools-title">Drawing Tools:</p>
                    <div class="flex items-center space-x-2 mb-2">
                        <input type="color" id="penColor" value="#000000" class="w-8 h-8 rounded-md border border-gray-300 cursor-pointer">
                        <label for="penColor" class="text-sm text-gray-700" id="pen-color-label">Pen Color</label>
                    </div>
                    <div class="flex items-center space-x-2 mb-4">
                        <input type="range" id="penSize" min="1" max="10" value="2" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <span class="text-sm text-gray-700" id="pen-size-label">Size: <span id="penSizeValue">2</span>px</span>
                    </div>
                    <button id="clearCanvas" class="px-4 py-2 bg-red-500 text-white rounded-md font-semibold hover:bg-red-600 transition duration-200">
                        <span id="clear-canvas-button-text">Clear Canvas</span>
                    </button>
                </div>

                <!-- Preset Icons -->
                <div class="flex flex-col p-3 bg-gray-50 rounded-md border border-gray-200 flex-grow">
                    <p class="text-gray-600 text-sm mb-2" id="preset-icons-title">Preset Icons:</p>
                    <div id="preset-icon-container" class="grid grid-cols-4 gap-2 justify-items-center">
                        <!-- Preset icons will be dynamically inserted here -->
                    </div>
                </div>
            </div>

            <canvas id="drawingCanvas" class="w-full h-64 md:h-80 rounded-md shadow-sm"></canvas>
            <p class="text-gray-600 text-sm mt-2 text-center" id="paste-image-info">
                (Note: Pasting images directly from clipboard is not supported in this simple version. Please use drawing tools and preset icons.)
            </p>
        </div>
    </div>

    <script type="module">
        // No Firebase imports needed for local storage

        let currentLanguage = 'en'; // Default language
        let selectedEmojis = []; // Stores the actual emoji characters
        let selectedActionSteps = []; // Stores the actual action step phrases
        let currentDate = new Date(); // Tracks the currently displayed date

        // --- Canvas Drawing Variables ---
        let canvas, ctx;
        let isDrawing = false;
        let drawingActions = []; // Stores drawing commands for saving/loading
        let penColor = '#000000';
        let penSize = 2;
        let activePresetIcon = null; // Stores the SVG string for the currently selected preset icon


        // Define a palette of colors for selected action steps
        const actionStepColorClasses = [
            'color-scheme-0', // Greenish
            'color-scheme-1', // Blueish
            'color-scheme-2', // Reddish
            'color-scheme-3', // Yellowish
            'color-scheme-4'  // Purplish
        ];

        const allEmojis = [
            "üòä", "üíñ", "‚òÄÔ∏è", "üå≥", "üè°", "ü´Ç", "üôè", "üí°", "üíß", "üìö",
            "üé∂", "üé®", "üåü", "üí™", "üçé", "üïäÔ∏è", "üéÅ", "‚ú®", "üåà", "‚òï"
        ];

        // New object to store emoji names in both languages
        const emojiNames = {
            "üòä": { en: "joy", fr: "joie" },
            "üíñ": { en: "love", fr: "amour" },
            "‚òÄÔ∏è": { en: "sun", fr: "soleil" },
            "üå≥": { en: "nature", fr: "nature" },
            "üè°": { en: "home", fr: "maison" },
            "ü´Ç": { en: "community", fr: "communaut√©" },
            "üôè": { en: "prayer", fr: "pri√®re" },
            "üí°": { en: "idea", fr: "id√©e" },
            "üíß": { en: "refreshment", fr: "rafra√Æchissement" },
            "ÔøΩ": { en: "learning", fr: "apprentissage" },
            "üé∂": { en: "music", fr: "musique" },
            "üé®": { en: "creativity", fr: "cr√©ativit√©" },
            "üåü": { en: "blessing", fr: "b√©n√©diction" },
            "üí™": { en: "strength", fr: "force" },
            "üçé": { en: "health", fr: "sant√©" },
            "üïäÔ∏è": { en: "peace", fr: "paix" },
            "üéÅ": { en: "gift", fr: "cadeau" },
            "‚ú®": { en: "sparkle", fr: "√©clat" },
            "üåà": { en: "hope", fr: "espoir" },
            "‚òï": { en: "comfort", fr: "confort" }
        };

        const allActionSteps = [
            { en: "Practice active listening", fr: "Pratiquer l'√©coute active" },
            { en: "Offer a genuine compliment", fr: "Faire un compliment sinc√®re" },
            { en: "Spend 15 mins in nature", fr: "Passer 15 min dans la nature" },
            { en: "Write a thank-you note", fr: "√âcrire une note de remerciement" },
            { en: "Help someone without being asked", fr: "Aider quelqu'un sans qu'on le demande" },
            { en: "Meditate for 5 minutes", fr: "M√©diter 5 minutes" },
            { en: "Read an inspiring passage", fr: "Lire un passage inspirant" },
            { en: "Forgive a past grievance", fr: "Pardonner une vieille rancune" },
            { en: "Connect with a loved one", fr: "Prendre contact avec un proche" },
            { en: "Do a small act of service", fr: "Faire un petit acte de service" },
            { en: "Learn something new", fr: "Apprendre quelque chose de nouveau" },
            { en: "Express gratitude verbally", fr: "Exprimer sa gratitude verbalement" },
            { en: "Take a mindful break", fr: "Faire une pause consciente" },
            { en: "Let go of control", fr: "L√¢cher prise sur le contr√¥le" },
            { en: "Share a smile with a stranger", fr: "Partager un sourire avec un inconnu" }
        ];

        // Updated: Preset icons for Visual Space - now with intrinsic colors in SVGs
        const presetIcons = [
            // Weather Icons (similar to image_e570ba.png)
            { name: { en: "Sunny", fr: "Ensoleill√©" }, svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><defs><linearGradient id="sunGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#FFD700"/><stop offset="100%" stop-color="#FFA500"/></linearGradient></defs><circle cx="12" cy="12" r="6" fill="url(#sunGrad)"/><path d="M12 2v2m0 16v2m8-10h2M2 12h2m14.364-7.364l-1.414 1.414M6.05 17.95l-1.414 1.414M17.95 6.05l1.414-1.414M6.05 6.05L4.636 4.636" stroke="#FF8C00" stroke-width="1.5" stroke-linecap="round"/></svg>' },
            { name: { en: "Partly Cloudy", fr: "Partiellement Nuageux" }, svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><defs><linearGradient id="partlyCloudySunGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#FFD700"/><stop offset="100%" stop-color="#FFA500"/></linearGradient></defs><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4c-3.72 0-6.83 2.81-7.35 6.41C2.57 11.49 1 13.68 1 16c0 3.31 2.69 6 6 6h11c3.87 0 7-3.13 7-7 0-3.59-2.65-6.54-6.09-6.96z" fill="#D3D3D3"/><circle cx="17" cy="7" r="3" fill="url(#partlyCloudySunGrad)"/></svg>' },
            { name: { en: "Cloudy", fr: "Nuageux" }, svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4c-3.72 0-6.83 2.81-7.35 6.41C2.57 11.49 1 13.68 1 16c0 3.31 2.69 6 6 6h11c3.87 0 7-3.13 7-7 0-3.59-2.65-6.54-6.09-6.96z" fill="#D3D3D3"/></svg>' },
            { name: { en: "Rainy", fr: "Pluvieux" }, svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4c-3.72 0-6.83 2.81-7.35 6.41C2.57 11.49 1 13.68 1 16c0 3.31 2.69 6 6 6h11c3.87 0 7-3.13 7-7 0-3.59-2.65-6.54-6.09-6.96z" fill="#D3D3D3"/><path d="M12 18v3m-3-3v3m6-3v3" stroke="#4682B4" stroke-width="2" stroke-linecap="round"/></svg>' },
            { name: { en: "Stormy", fr: "Orageux" }, svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4c-3.72 0-6.83 2.81-7.35 6.41C2.57 11.49 1 13.68 1 16c0 3.31 2.69 6 6 6h11c3.87 0 7-3.13 7-7 0-3.59-2.65-6.54-6.09-6.96z" fill="#808080"/><path d="M15 14h-3l-2 5h2l-3 5h2l-2 5z" fill="#FFD700"/></svg>' },
            { name: { en: "Snowy", fr: "Neigeux" }, svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4c-3.72 0-6.83 2.81-7.35 6.41C2.57 11.49 1 13.68 1 16c0 3.31 2.69 6 6 6h11c3.87 0 7-3.13 7-7 0-3.59-2.65-6.54-6.09-6.96z" fill="#D3D3D3"/><path d="M12 18.5v1.5m-1.5-1.5l1.5 1.5m1.5-1.5l-1.5 1.5M8 18.5v1.5m-1.5-1.5l1.5 1.5m1.5-1.5l-1.5 1.5M16 18.5v1.5m-1.5-1.5l1.5 1.5m1.5-1.5l-1.5 1.5" stroke="#ADD8E6" stroke-width="2" stroke-linecap="round"/></svg>' },
            { name: { en: "Windy", fr: "Venteux" }, svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 12h14M7 15l-2 2M17 15l2 2" stroke="#B0C4DE" stroke-width="2" stroke-linecap="round"/><path d="M4 10a3 3 0 110 6h16a3 3 0 110-6H4z" fill="#B0C4DE"/></svg>' },
            { name: { en: "Night (Moon)", fr: "Nuit (Lune)" }, svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 3a9 9 0 109 9c0-.46-.04-.92-.12-1.36a5.5 5.5 0 01-1.84-8.88C19.1 3.51 15.7 2 12 2z" fill="#FFD700"/><circle cx="18" cy="6" r="1.5" fill="#FFFFFF"/><circle cx="15" cy="3" r="1" fill="#FFFFFF"/><circle cx="21" cy="10" r="1" fill="#FFFFFF"/></svg>' },

            // Season Icons (similar to image_e56cdc.png)
            { name: { en: "Summer", fr: "√ât√©" }, svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><defs><linearGradient id="summerSunGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#FFC107"/><stop offset="100%" stop-color="#FF8F00"/></linearGradient></defs><circle cx="12" cy="12" r="6" fill="url(#summerSunGrad)"/><path d="M12 2v2m0 16v2m8-10h2M2 12h2m14.364-7.364l-1.414 1.414M6.05 17.95l-1.414 1.414M17.95 6.05l1.414-1.414M6.05 6.05L4.636 4.636" stroke="#FF8F00" stroke-width="1.5" stroke-linecap="round"/></svg>' },
            { name: { en: "Spring", fr: "Printemps" }, svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="4" fill="#9CCC65"/><path d="M12 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 18c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" fill="#FF69B4" stroke="#C2185B" stroke-width="1.5"/></svg>' },
            { name: { en: "Autumn", fr: "Automne" }, svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17.41 6.59c-.39-.39-1.02-.39-1.41 0L12 10.59 8.01 6.59c-.39-.39-1.02-.39-1.41 0s-.39 1.02 0 1.41L10.59 12 6.59 15.99c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0L12 13.41l3.99 3.99c.39.39 1.02.39 1.41 0s.39-1.02 0-1.41L13.41 12l3.99-3.99c.39-.39.39-1.02 0-1.41z" fill="#FFA500" stroke="#E65100" stroke-width="1.5"/><path d="M12 13.41l-1.5-1.5-1.5 1.5-1.5-1.5-1.5 1.5-1.5-1.5L6.59 12 12 6.59 17.41 12 12 17.41z" fill="#D2691E"/></svg>' },
            { name: { en: "Winter", fr: "Hiver" }, svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 18c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM12 8a4 4 0 100 8 4 4 0 000-8z" fill="#ADD8E6" stroke="#64B5F6" stroke-width="1.5"/><path d="M12 8v8m-4-4h8m-4-4l2 4m-2 0l-2-4" stroke="#64B5F6" stroke-width="1.5" stroke-linecap="round"/></svg>' }
        ];


        const content = {
            "en": {
                mainTitle: "üåÖ Morning Reflection",
                reminderPrefix: "", /* Removed "Reminder:" */
                scriptureTitle: "Scripture of the Day",
                verseReflectionTitle: "What does this verse mean to me today?",
                verseReflectionPlaceholder: "Write your thoughts here",
                personalPrayerTitle: "Personal Prayer",
                personalPrayerSubtitle: "Talk to God about your hopes and needs today. Here's a suggestion to inspire you:",
                spiritualChallengeTitle: "Spiritual Challenge of the Day:",
                gratitudeTitle: "Gratitude Prompt",
                gratitudeSubtitle: "Today, I am thankful for...",
                emojiInstructions: "Choose up to 4 emojis that represent your gratitude today:",
                gratitudePlaceholder: "Write your list here",
                actionStepTitle: "Action Step",
                actionStepSubtitle: "One way I will live out today‚Äôs verse is...",
                actionInstructions: "Choose up to 4 action steps to focus on today:",
                actionStepPlaceholder: "Elaborate on your chosen action steps or write your own here.",
                visualSpaceTitle: "Visual Space",
                visualSpaceSubtitle: "Sketch, doodle, or paste an image that reflects your morning inspiration.",
                drawingToolsTitle: "Drawing Tools:",
                penColorLabel: "Pen Color",
                penSizeLabel: "Size:",
                clearCanvasButtonText: "Clear Canvas",
                presetIconsTitle: "Preset Icons:",
                pasteImageInfo: "(Note: Pasting images directly from clipboard is not supported in this simple version. Click an icon, then click the canvas to stamp it.)",
                daily: {
                    "Monday": {
                        scripture: {
                            text: "Trust in the Lord with all your heart and lean not on your own understanding; in all your ways submit to Him, and He will make your paths straight.",
                            reference: "Proverbs 3:5-6"
                        },
                        prayerSuggestion: "Heavenly Father, on this Monday, I come before You seeking strength and guidance. Help me to trust in Your wisdom completely, even when I don't understand Your plan. Guide my steps today and make my path straight according to Your will. Amen.",
                        reminder: "You are not walking alone. God is lighting the path, even when it curves.",
                        spiritualChallengeTheme: "Strength & Guidance",
                        spiritualChallengePrompt: "Consider a specific area where you tend to rely on your own understanding. How can you intentionally surrender that to God today?"
                    },
                    "Tuesday": {
                        scripture: {
                            text: "The Lord is my light and my salvation‚Äîwhom shall I fear? The Lord is the stronghold of my life‚Äîof whom shall I be afraid?",
                            reference: "Psalm 27:1"
                        },
                        prayerSuggestion: "Lord, today I seek Your peace and comfort. Be my light in any darkness and my salvation from all fear. I declare You as the stronghold of my life. Help me to walk in courage and find rest in Your presence. Amen.",
                        reminder: "Peace isn‚Äôt the absence of fear‚Äîit‚Äôs the presence of God.",
                        spiritualChallengeTheme: "Peace & Comfort",
                        spiritualChallengePrompt: "Identify a situation causing you anxiety. How can you invite God's peace into it?"
                    },
                    "Wednesday": {
                        scripture: {
                            text: "But those who hope in the Lord will renew their strength. They will soar on wings like eagles; they will run and not grow weary, they will walk and not be faint.",
                            reference: "Isaiah 40:31"
                        },
                        prayerSuggestion: "Gracious God, as I face this Wednesday, I pray for renewed strength and fresh perspective. Help me to hope in You, knowing that You will lift me up and enable me to overcome weariness. Grant me the patience to wait on Your timing. Amen.",
                        reminder: "Waiting isn‚Äôt wasting‚Äîit‚Äôs preparing.",
                        spiritualChallengeTheme: "Patience & Perspective",
                        spiritualChallengePrompt: "What is one area where you need to release control and trust God's timing?"
                    },
                    "Thursday": {
                        scripture: {
                            text: "Create in me a pure heart, O God, and renew a steadfast spirit within me.",
                            reference: "Psalm 51:10"
                        },
                        prayerSuggestion: "Merciful Father, on this Thursday, I come seeking Your forgiveness and renewal. Cleanse my heart and renew a steadfast spirit within me. Help me to walk in integrity and to reflect Your purity in all I do. Amen.",
                        reminder: "Renewal begins with release.",
                        spiritualChallengeTheme: "Forgiveness & Renewal",
                        spiritualChallengePrompt: "Is there anyone you need to forgive, or an area where you need God's forgiveness and renewal?"
                    },
                    "Friday": {
                        scripture: {
                            text: "Be kind and compassionate to one another, forgiving each other, just as in Christ God forgave you.",
                            reference: "Ephesians 4:32"
                        },
                        prayerSuggestion: "Loving God, as the week draws to a close, fill my heart with Your love and compassion. Help me to be kind and understanding towards others, extending forgiveness as You have so freely given it to me. May my actions reflect Your boundless love. Amen.",
                        reminder: "Every act of compassion is a reflection of God‚Äôs love.",
                        spiritualChallengeTheme: "Love & Compassion",
                        spiritualChallengePrompt: "How can you show intentional kindness or compassion to someone today?"
                    },
                    "Saturday": {
                        scripture: {
                            text: "Come to me, all you who are weary and burdened, and I will give you rest.",
                            reference: "Matthew 11:28"
                        },
                        prayerSuggestion: "Resting Father, on this Saturday, I lay my weariness and burdens before You. I come seeking the rest only You can provide. Help me to surrender my worries and trust in Your unfailing care. Refresh my soul and spirit. Amen.",
                        reminder: "Let go. Breathe. Rest. God is still working while you sleep.",
                        spiritualChallengeTheme: "Rest & Surrender",
                        spiritualChallengePrompt: "What burden can you intentionally surrender to God today to find rest?"
                    },
                    "Sunday": {
                        scripture: {
                            text: "This is the day that the Lord has made; let us rejoice and be glad in it.",
                            reference: "Psalm 118:24"
                        },
                        prayerSuggestion: "Joyful Lord, on this blessed Sunday, I rejoice in the day You have made. Fill my heart with gladness and my spirit with worship. Help me to celebrate Your goodness and to share Your joy with those around me. Amen.",
                        reminder: "La paix n'est pas l'absence de peur, c'est la pr√©sence de Dieu.",
                        spiritualChallengeTheme: "Joie et Adoration",
                        spiritualChallengePrompt: "How can you intentionally cultivate joy and express worship today?"
                    }
                }
            },
            "fr": {
                mainTitle: "üåÖ R√©flexion Matinale",
                reminderPrefix: "", /* Removed "Rappel :" */
                scriptureTitle: "√âcriture du Jour",
                verseReflectionTitle: "Que signifie ce verset pour moi aujourd'sui ?",
                verseReflectionPlaceholder: "√âcrivez vos pens√©es ici",
                personalPrayerTitle: "Pri√®re Personnelle",
                personalPrayerSubtitle: "Parlez √† Dieu de vos espoirs et de vos besoins aujourd'hui. Voici une suggestion pour vous inspirer :",
                spiritualChallengeTitle: "D√©fi Spirituel du Jour :",
                gratitudeTitle: "Invite √† la Gratitude",
                gratitudeSubtitle: "Aujourd'hui, je suis reconnaissant(e) pour...",
                emojiInstructions: "Choisissez jusqu'√† 4 √©mojis qui repr√©sentent votre gratitude aujourd'hui :",
                gratitudePlaceholder: "√âcrivez votre liste ici",
                actionStepTitle: "√âtape d'Action",
                actionStepSubtitle: "Une fa√ßon de vivre le verset d'aujourd'hui est...",
                actionInstructions: "Choisissez jusqu'√† 4 √©tapes d'action sur lesquelles vous concentrer aujourd'hui :",
                actionStepPlaceholder: "√âlaborez sur vos √©tapes d'action choisies ou √©crivez les v√¥tres ici.",
                visualSpaceTitle: "Espace Visuel",
                visualSpaceSubtitle: "Dessinez, gribouillez ou collez une image qui refl√®te votre inspiration matinale.",
                drawingToolsTitle: "Outils de Dessin :",
                penColorLabel: "Couleur du Stylo",
                penSizeLabel: "Taille :",
                clearCanvasButtonText: "Effacer le Canevas",
                presetIconsTitle: "Ic√¥nes Pr√©d√©finies :",
                pasteImageInfo: "(Note : Le collage d'images directement depuis le presse-papiers n'est pas pris en charge dans cette version simple. Cliquez sur une ic√¥ne, puis sur le canevas pour l'estampiller.)",
                daily: {
                    "Monday": {
                        scripture: {
                            text: "Confie-toi en l'√âternel de tout ton c≈ìur, et ne t'appuie pas sur ta sagesse; reconnais-le dans toutes tes voies, et il aplanira tes sentiers.",
                            reference: "Proverbes 3:5-6"
                        },
                        prayerSuggestion: "P√®re C√©leste, en ce lundi, je viens devant Toi cherchant force et direction. Aide-moi √† me confier enti√®rement en Ta sagesse, m√™me lorsque je ne comprends pas Ton plan. Guide mes pas aujourd'hui et rends mes chemins droits selon Ta volont√©. Amen.",
                        reminder: "La paix n'est pas l'absence de peur, c'est la pr√©sence de Dieu.",
                        spiritualChallengeTheme: "Force et Direction",
                        spiritualChallengePrompt: "Consid√©rez un domaine sp√©cifique o√π vous avez tendance √† vous fier √† votre propre compr√©hension. Comment pouvez-vous intentionnellement abandonner cela √† Dieu aujourd'hui ?"
                    },
                    "Tuesday": {
                        scripture: {
                            text: "L'√âternel est ma lumi√®re et mon salut : de qui aurais-je crainte ? L'√âternel est le soutien de ma vie : de qui aurais-je peur ?",
                            reference: "Psalm 27:1"
                        },
                        prayerSuggestion: "Seigneur, aujourd'hui je cherche Ta paix et Ton r√©confort. Sois ma lumi√®re dans toute obscurit√© et mon salut contre toute peur. Je Te d√©clare comme la forteresse de ma vie. Aide-moi √† marcher avec courage et √† trouver le repos en Ta pr√©sence. Amen.",
                        reminder: "Attendre n'est pas perdre son temps, c'est se pr√©parer.",
                        spiritualChallengeTheme: "Paix et R√©confort",
                        spiritualChallengePrompt: "Identifiez une situation qui vous cause de l'anxi√©t√©. Comment pouvez-vous y inviter la paix de Dieu ?"
                    },
                    "Wednesday": {
                        scripture: {
                            text: "Mais ceux qui s'attendent √† l'√âternel renouvellent leur force. Ils prennent le vol comme les aigles; ils courent et ne se lassent point, ils marchent et ne se fatiguent point.",
                            reference: "√âsa√Øe 40:31"
                        },
                        prayerSuggestion: "Dieu bienveillant, alors que j'affronte ce mercredi, je prie pour une force renouvel√©e et une nouvelle perspective. Aide-moi √† esp√©rer en Toi, sachant que Tu me rel√®veras et me permettras de surmonter la fatigue. Accorde-moi la patience d'attendre Ton timing. Amen.",
                        reminder: "Le renouveau commence par le l√¢cher-prise.",
                        spiritualChallengeTheme: "Patience et Perspective",
                        spiritualChallengePrompt: "Quel est un domaine o√π vous devez l√¢cher prise et faire confiance au timing de Dieu ?"
                    },
                    "Thursday": {
                        scripture: {
                            text: "√î Dieu ! cr√©e en moi un c≈ìur pur, et renouvelle en moi un esprit bien dispos√©.",
                            reference: "Psaume 51:10"
                        },
                        prayerSuggestion: "P√®re mis√©ricordieux, en ce jeudi, je viens chercher Ton pardon et Ton renouveau. Purifie mon c≈ìur et renouvelle un esprit ferme en moi. Aide-moi √† marcher avec int√©grit√© et √† refl√©ter Ta puret√© in all I do. Amen.",
                        reminder: "Chaque acte de compassion est un reflet de l'amour de Dieu.",
                        spiritualChallengeTheme: "Pardon et Renouveau",
                        spiritualChallengePrompt: "Y a-t-il quelqu'un que vous devez pardonner, ou un domaine o√π vous avez besoin du pardon et du renouveau de Dieu ?"
                    },
                    "Friday": {
                        scripture: {
                            text: "Soyez bons les uns envers les autres, compatissants, vous pardonnant r√©ciproquement, comme Dieu vous a pardonn√© en Christ.",
                            reference: "√âph√©siens 4:32"
                        },
                        prayerSuggestion: "Loving God, as the week draws to a close, fill my heart with Your love and compassion. Help me to be kind and understanding towards others, extending forgiveness as You have so freely given it to me. May my actions reflect Your boundless love. Amen.",
                        reminder: "Every act of compassion is a reflection of God‚Äôs love.",
                        spiritualChallengeTheme: "Love & Compassion",
                        spiritualChallengePrompt: "How can you show intentional kindness or compassion to someone today?"
                    },
                    "Saturday": {
                        scripture: {
                            text: "Come to me, all you who are weary and burdened, and I will give you rest.",
                            reference: "Matthew 11:28"
                        },
                        prayerSuggestion: "Resting Father, on this Saturday, I lay my weariness and burdens before You. I come seeking the rest only You can provide. Help me to surrender my worries and trust in Your unfailing care. Refresh my soul and spirit. Amen.",
                        reminder: "Let go. Breathe. Rest. God is still working while you sleep.",
                        spiritualChallengeTheme: "Rest & Surrender",
                        spiritualChallengePrompt: "What burden can you intentionally surrender to God today to find rest?"
                    },
                    "Sunday": {
                        scripture: {
                            text: "This is the day that the Lord has made; let us rejoice and be glad in it.",
                            reference: "Psalm 118:24"
                        },
                        prayerSuggestion: "Joyful Lord, on this blessed Sunday, I rejoice in the day You have made. Fill my heart with gladness and my spirit with worship. Help me to celebrate Your goodness and to share Your joy with those around me. Amen.",
                        reminder: "La paix n'est pas l'absence de peur, c'est la pr√©sence de Dieu.",
                        spiritualChallengeTheme: "Joie et Adoration",
                        spiritualChallengePrompt: "How can you intentionally cultivate joy and express worship today?"
                    }
                }
            }
        };

        /**
         * Initializes the canvas for drawing.
         */
        const initializeCanvas = () => {
            canvas = document.getElementById('drawingCanvas');
            ctx = canvas.getContext('2d');

            // Set canvas dimensions to fill its container
            const setCanvasDimensions = () => {
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                // Clear and redraw when resized to maintain aspect ratio and prevent stretching
                redrawCanvas();
            };

            setCanvasDimensions(); // Set initial dimensions
            window.addEventListener('resize', setCanvasDimensions); // Adjust on resize

            // Drawing event listeners for mouse
            canvas.addEventListener('mousedown', (e) => {
                if (activePresetIcon) {
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    drawingActions.push({ type: 'icon', x, y, svg: activePresetIcon });
                    redrawCanvas();
                    activePresetIcon = null; // Deselect icon after drawing
                    generatePresetIconButtons(); // Re-render buttons to show deselection
                    canvas.style.cursor = 'crosshair'; // Reset cursor
                    return;
                }
                isDrawing = true;
                [lastX, lastY] = [e.offsetX, e.offsetY];
                drawingActions.push({ type: 'path', segments: [], color: penColor, size: penSize });
            });

            canvas.addEventListener('mousemove', (e) => {
                if (!isDrawing) return;
                const currentX = e.offsetX;
                const currentY = e.offsetY;
                const lastPath = drawingActions[drawingActions.length - 1];
                if (lastPath && lastPath.type === 'path') {
                    lastPath.segments.push({ x1: lastX, y1: lastY, x2: currentX, y2: currentY });
                }
                lastX = currentX;
                lastY = currentY;
                redrawCanvas(); // Redraw entire canvas for smooth drawing
            });

            canvas.addEventListener('mouseup', () => isDrawing = false);
            canvas.addEventListener('mouseout', () => isDrawing = false); // Stop drawing if mouse leaves canvas

            // Drawing event listeners for touch
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault(); // Prevent scrolling
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;

                if (activePresetIcon) {
                    drawingActions.push({ type: 'icon', x, y, svg: activePresetIcon });
                    redrawCanvas();
                    activePresetIcon = null; // Deselect icon after drawing
                    generatePresetIconButtons(); // Re-render buttons to show deselection
                    canvas.style.cursor = 'crosshair'; // Reset cursor
                    return;
                }
                isDrawing = true;
                [lastX, lastY] = [x, y];
                drawingActions.push({ type: 'path', segments: [], color: penColor, size: penSize });
            }, { passive: false });

            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault(); // Prevent scrolling
                if (!isDrawing) return;
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const currentX = touch.clientX - rect.left;
                const currentY = touch.clientY - rect.top;

                const lastPath = drawingActions[drawingActions.length - 1];
                if (lastPath && lastPath.type === 'path') {
                    lastPath.segments.push({ x1: lastX, y1: lastY, x2: currentX, y2: currentY });
                }
                lastX = currentX;
                lastY = currentY;
                redrawCanvas(); // Redraw entire canvas for smooth drawing
            }, { passive: false });

            canvas.addEventListener('touchend', () => isDrawing = false);
            canvas.addEventListener('touchcancel', () => isDrawing = false);

            // Pen color and size controls
            document.getElementById('penColor').addEventListener('input', (e) => {
                penColor = e.target.value;
            });
            document.getElementById('penSize').addEventListener('input', (e) => {
                penSize = parseInt(e.target.value);
                document.getElementById('penSizeValue').textContent = penSize;
            });
            document.getElementById('clearCanvas').addEventListener('click', () => {
                drawingActions = []; // Clear all stored drawing actions
                redrawCanvas(); // Clear the visual canvas
            });
        };

        /**
         * Redraws the entire canvas based on the stored drawingActions array.
         */
        const redrawCanvas = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#ffffff'; // Set background to white
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            drawingActions.forEach(action => {
                if (action.type === 'path') {
                    ctx.strokeStyle = action.color;
                    ctx.lineWidth = action.size;
                    ctx.lineCap = 'round';
                    action.segments.forEach(segment => {
                        ctx.beginPath();
                        ctx.moveTo(segment.x1, segment.y1);
                        ctx.lineTo(segment.x2, segment.y2);
                        ctx.stroke();
                    });
                } else if (action.type === 'icon') {
                    drawPresetIconOnCanvas(action.x, action.y, action.svg);
                }
            });
        };

        /**
         * Draws a selected preset SVG icon onto the canvas at specified coordinates.
         * This is called by redrawCanvas, so it doesn't add to drawingActions.
         * @param {number} x - X coordinate on canvas.
         * @param {number} y - Y coordinate on canvas.
         * @param {string} svgString - The SVG string to draw.
         */
        const drawPresetIconOnCanvas = (x, y, svgString) => {
            const img = new Image();
            const svgDataUrl = 'data:image/svg+xml;base64,' + btoa(svgString);
            const iconSize = 50; // pixels

            img.onload = () => {
                ctx.drawImage(img, x - iconSize / 2, y - iconSize / 2, iconSize, iconSize);
            };
            img.src = svgDataUrl;
        };

        /**
         * Generates and renders preset icon buttons.
         */
        const generatePresetIconButtons = () => {
            const presetIconContainer = document.getElementById('preset-icon-container');
            presetIconContainer.innerHTML = ''; // Clear existing buttons

            presetIcons.forEach(icon => {
                const button = document.createElement('button');
                button.classList.add('preset-icon-button'); // Apply common styling class
                button.innerHTML = icon.svg; // Set innerHTML to the SVG string

                // Add a title for accessibility and hover tooltip
                button.title = icon.name[currentLanguage];

                if (activePresetIcon === icon.svg) {
                    button.classList.add('selected'); // Highlight selected preset icon button
                } else {
                    button.classList.remove('selected'); // Ensure it's not selected
                }

                button.addEventListener('click', () => {
                    // Deselect previous if any
                    if (activePresetIcon) {
                        const prevSelectedButton = presetIconContainer.querySelector(`.preset-icon-button.selected`);
                        if (prevSelectedButton) {
                            prevSelectedButton.classList.remove('selected');
                        }
                    }

                    if (activePresetIcon === icon.svg) {
                        // If clicking the same icon, deselect it
                        activePresetIcon = null;
                        canvas.style.cursor = 'crosshair'; // Reset cursor
                    } else {
                        // Select new icon
                        activePresetIcon = icon.svg;
                        button.classList.add('selected'); // Apply selected class to the new button
                        canvas.style.cursor = 'copy'; // Change cursor to indicate stamping
                    }
                });
                presetIconContainer.appendChild(button);
            });
        };


        /**
         * Updates the display area with the currently selected emojis.
         */
        const updateSelectedEmojisDisplay = () => {
            document.getElementById('selected-emojis-display').textContent = selectedEmojis.join(' ');
        };

        /**
         * Toggles the selection of an emoji and updates the display.
         * @param {string} emoji - The emoji character to toggle.
         * @param {HTMLElement} button - The button element corresponding to the emoji.
         */
        const toggleEmojiSelection = (emoji, button) => {
            const index = selectedEmojis.indexOf(emoji);
            if (index > -1) {
                // Emoji is already selected, so unselect it
                selectedEmojis.splice(index, 1);
                button.classList.remove('bg-blue-200', 'border-blue-500');
                button.classList.add('bg-gray-100', 'border-gray-300');
            } else {
                // Emoji is not selected, try to select it
                if (selectedEmojis.length < 4) {
                    // Only allow selection if less than 4 emojis are already selected
                    selectedEmojis.push(emoji);
                    button.classList.add('bg-blue-200', 'border-blue-500');
                    button.classList.remove('bg-gray-100', 'border-gray-300');
                } else {
                    // Optionally, provide user feedback that max selection is reached
                    return;
                }
            }
            updateSelectedEmojisDisplay(); // Update the display of selected emojis
        };

        /**
         * Generates and renders all emoji buttons in the picker container.
         * Attaches click listeners and sets initial styling based on selection.
         */
        const generateEmojiButtons = () => {
            const emojiContainer = document.getElementById('emoji-picker-container');
            emojiContainer.innerHTML = ''; // Clear any existing buttons

            allEmojis.forEach(emoji => {
                const emojiItemDiv = document.createElement('div');
                emojiItemDiv.classList.add('flex', 'flex-col', 'items-center', 'justify-center', 'p-1', 'rounded-md'); // Container for emoji and name

                const button = document.createElement('button');
                button.textContent = emoji;
                button.classList.add(
                    'emoji-button', 'p-2', 'rounded-full', 'text-2xl', 'border-2',
                    'transition', 'duration-150', 'ease-in-out', 'hover:scale-110'
                );
                // Set initial styling based on whether the emoji is currently selected
                if (selectedEmojis.includes(emoji)) {
                    button.classList.add('bg-blue-200', 'border-blue-500');
                } else {
                    button.classList.add('bg-gray-100', 'border-gray-300');
                }
                // Add click event listener to toggle selection
                button.addEventListener('click', () => toggleEmojiSelection(emoji, button));

                const emojiNameSpan = document.createElement('span');
                emojiNameSpan.classList.add('text-xs', 'text-gray-600', 'mt-1', 'text-center', 'emoji-name');
                // Ensure emojiNames[emoji] exists before trying to access properties
                emojiNameSpan.textContent = emojiNames[emoji] ? emojiNames[emoji][currentLanguage] : '';

                emojiItemDiv.appendChild(button);
                emojiItemDiv.appendChild(emojiNameSpan);
                emojiContainer.appendChild(emojiItemDiv);
            });
        };

        /**
         * Updates the display area with the currently selected action steps.
         */
        const updateSelectedActionStepsDisplay = () => {
            document.getElementById('selected-action-steps-display').textContent = selectedActionSteps.join(' ‚Ä¢ ');
        };

        /**
         * Toggles the selection of an action step and updates the display.
         * @param {string} actionStep - The action step phrase to toggle.
         * @param {HTMLElement} button - The button element corresponding to the action step.
         */
        const toggleActionStepSelection = (actionStep, button) => {
            const index = selectedActionSteps.indexOf(actionStep);
            // Remove all color classes from the button first to reset it
            actionStepColorClasses.forEach(colorClass => button.classList.remove(colorClass));

            if (index > -1) {
                // Action step is already selected, so unselect it
                selectedActionSteps.splice(index, 1);
                button.classList.remove('selected'); // Remove the generic 'selected' class
            } else {
                // Action step is not selected, try to select it
                if (selectedActionSteps.length < 4) { // Changed limit from 2 to 4 action steps
                    selectedActionSteps.push(actionStep);
                    button.classList.add('selected'); // Add generic 'selected' class

                    // Assign a unique color based on its position in the *currently selected* array
                    const colorIndex = selectedActionSteps.indexOf(actionStep); // Get its position in the selected array
                    button.classList.add(actionStepColorClasses[colorIndex % actionStepColorClasses.length]);
                } else {
                    // Optionally, provide user feedback that max selection is reached
                    return;
                }
            }
            // After modifying selectedActionSteps, re-render all buttons to ensure correct colors are applied
            // to previously selected items whose positions might have shifted.
            generateActionStepButtons();
            updateSelectedActionStepsDisplay(); // Update the display of selected action steps
        };


        /**
         * Generates and renders all action step buttons in the picker container.
         * Attaches click listeners and sets initial styling based on selection.
         */
        const generateActionStepButtons = () => {
            const actionStepContainer = document.getElementById('action-step-picker-container');
            actionStepContainer.innerHTML = ''; // Clear any existing buttons

            allActionSteps.forEach(action => {
                const button = document.createElement('button');
                button.textContent = action[currentLanguage];
                button.classList.add('action-step-button');

                // Check if this action step is currently selected
                const isSelected = selectedActionSteps.includes(action[currentLanguage]);
                if (isSelected) {
                    // Find the index of this action step in the selectedActionSteps array
                    const selectedIndex = selectedActionSteps.indexOf(action[currentLanguage]);
                    // Apply the corresponding color class
                    const colorClass = actionStepColorClasses[selectedIndex % actionStepColorClasses.length];
                    button.classList.add(colorClass);
                    button.classList.add('selected'); // Also add the generic 'selected' class
                }
                
                // Add click event listener to toggle selection
                button.addEventListener('click', () => toggleActionStepSelection(action[currentLanguage], button));
                actionStepContainer.appendChild(button);
            });
        };

        /**
         * Formats a Date object into a "YYYY-MM-DD" string.
         * @param {Date} date - The date object.
         * @returns {string} Formatted date string.
         */
        const formatDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        /**
         * Clears all input fields and canvas.
         */
        const clearEntryFields = () => {
            document.getElementById('verse-reflection-textarea').value = '';
            document.getElementById('prayer-textarea').value = '';
            document.getElementById('spiritual-challenge-textarea').value = '';
            document.getElementById('gratitude-textarea').value = '';
            selectedEmojis = [];
            selectedActionSteps = [];
            drawingActions = []; // Clear drawing actions
            updateSelectedEmojisDisplay();
            generateActionStepButtons(); // Re-render action buttons to clear selections
            redrawCanvas(); // Clear the visual canvas
        };

        /**
         * Displays a status message to the user.
         * @param {string} message - The message to display.
         * @param {string} type - 'success', 'error', or 'info'.
         */
        const showStatusMessage = (message, type) => {
            const statusDiv = document.getElementById('save-status-message');
            statusDiv.textContent = message;
            statusDiv.className = 'text-center text-sm mt-2'; // Reset classes
            if (type === 'success') {
                statusDiv.classList.add('text-green-600');
            } else if (type === 'error') {
                statusDiv.classList.add('text-red-600');
            } else {
                statusDiv.classList.add('text-gray-600');
            }
            setTimeout(() => statusDiv.textContent = '', 3000); // Clear after 3 seconds
        };

        /**
         * Saves the current day's entry to Local Storage.
         */
        const saveEntry = () => {
            showStatusMessage("Saving entry to local storage...", 'info');
            const dateString = formatDate(currentDate);

            const entryData = {
                date: dateString,
                verseReflection: document.getElementById('verse-reflection-textarea').value,
                personalPrayer: document.getElementById('prayer-textarea').value,
                spiritualChallenge: document.getElementById('spiritual-challenge-textarea').value,
                gratitudeText: document.getElementById('gratitude-textarea').value,
                selectedEmojis: selectedEmojis,
                selectedActionSteps: selectedActionSteps,
                drawingActions: drawingActions // Store the array of drawing commands
            };

            try {
                localStorage.setItem(`journal_entry_${dateString}`, JSON.stringify(entryData));
                showStatusMessage("Entry saved successfully to local storage!", 'success');
            } catch (e) {
                console.error("Error saving to local storage: ", e);
                showStatusMessage("Error saving entry to local storage.", 'error');
            }
        };

        /**
         * Loads an entry for a specific date from Local Storage.
         * @param {Date} dateToLoad - The Date object for the entry to load.
         */
        const loadEntry = (dateToLoad) => {
            showStatusMessage("Loading entry from local storage...", 'info');
            const dateString = formatDate(dateToLoad);

            try {
                const storedData = localStorage.getItem(`journal_entry_${dateString}`);

                clearEntryFields(); // Clear current fields before loading new data

                if (storedData) {
                    const data = JSON.parse(storedData);
                    document.getElementById('verse-reflection-textarea').value = data.verseReflection || '';
                    document.getElementById('prayer-textarea').value = data.personalPrayer || '';
                    document.getElementById('spiritual-challenge-textarea').value = data.spiritualChallenge || '';
                    document.getElementById('gratitude-textarea').value = data.gratitudeText || '';
                    selectedEmojis = data.selectedEmojis || [];
                    selectedActionSteps = data.selectedActionSteps || [];
                    drawingActions = data.drawingActions || []; // Load drawing actions
                    
                    updateSelectedEmojisDisplay();
                    generateActionStepButtons(); // Re-render to show loaded selections
                    redrawCanvas(); // Redraw canvas with loaded actions

                    showStatusMessage("Entry loaded from local storage.", 'success');
                } else {
                    showStatusMessage("No entry found for this date. Starting a new one.", 'info');
                }
                currentDate = dateToLoad; // Update current date after successful load attempt
                updateContent(currentLanguage); // Update daily content for the new date
            } catch (e) {
                console.error("Error loading from local storage: ", e);
                showStatusMessage("Error loading entry from local storage.", 'error');
            }
        };

        /**
         * Updates all dynamic content on the page based on the selected language and current date.
         * @param {string} lang - The language code ('en' or 'fr').
         */
        const updateContent = (lang) => {
            const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            const dayName = days[currentDate.getDay()];
            // Get daily content for the current day, defaulting to Monday if not found
            const dailyData = content[lang].daily[dayName] || content[lang].daily["Monday"];

            // Update static elements based on language
            document.getElementById('main-title').textContent = content[lang].mainTitle;
            document.getElementById('scripture-title').textContent = content[lang].scriptureTitle;
            document.getElementById('verse-reflection-title').textContent = content[lang].verseReflectionTitle;
            document.getElementById('verse-reflection-textarea').placeholder = content[lang].verseReflectionPlaceholder;
            document.getElementById('personal-prayer-title').textContent = content[lang].personalPrayerTitle;
            document.getElementById('personal-prayer-subtitle').textContent = content[lang].personalPrayerSubtitle;
            document.getElementById('gratitude-title').textContent = content[lang].gratitudeTitle;
            document.getElementById('gratitude-subtitle').textContent = content[lang].gratitudeSubtitle;
            document.getElementById('emoji-instructions').textContent = content[lang].emojiInstructions; // New emoji instructions
            document.getElementById('gratitude-textarea').placeholder = content[lang].gratitudePlaceholder;

            // Action Step section updates
            document.getElementById('action-step-title').textContent = content[lang].actionStepTitle;
            document.getElementById('action-step-subtitle').textContent = content[lang].actionStepSubtitle;
            document.getElementById('action-instructions').textContent = content[lang].actionInstructions;
            document.getElementById('action-step-textarea').placeholder = content[lang].actionStepPlaceholder;

            // Visual Space section updates
            document.getElementById('visual-space-title').textContent = content[lang].visualSpaceTitle;
            document.getElementById('visual-space-subtitle').textContent = content[lang].visualSpaceSubtitle;
            document.getElementById('drawing-tools-title').textContent = content[lang].drawingToolsTitle;
            document.getElementById('pen-color-label').textContent = content[lang].penColorLabel;
            document.getElementById('pen-size-label').innerHTML = `${content[lang].penSizeLabel} <span id="penSizeValue">${penSize}</span>px`;
            document.getElementById('clear-canvas-button-text').textContent = content[lang].clearCanvasButtonText;
            document.getElementById('preset-icons-title').textContent = content[lang].presetIconsTitle;
            document.getElementById('paste-image-info').textContent = content[lang].pasteImageInfo;


            // Update dynamic daily content
            document.getElementById('daily-reminder').textContent = dailyData.reminder;
            document.getElementById('scripture-text').textContent = dailyData.scripture.text;
            document.getElementById('scripture-reference').textContent = dailyData.scripture.reference;
            document.getElementById('prayer-textarea').placeholder = dailyData.prayerSuggestion;

            const spiritualChallengeFullTitleElement = document.getElementById('spiritual-challenge-full-title');
            if (spiritualChallengeFullTitleElement) {
                spiritualChallengeFullTitleElement.textContent = content[lang].spiritualChallengeTitle + " " + dailyData.spiritualChallengeTheme;
            } else {
                console.error("Element with ID 'spiritual-challenge-full-title' not found.");
            }

            document.getElementById('challenge-prompt').textContent = dailyData.spiritualChallengePrompt;
            document.getElementById('spiritual-challenge-textarea').placeholder = dailyData.spiritualChallengePrompt;

            // Update current date display
            document.getElementById('current-date-display').textContent = currentDate.toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });

            // Re-generate emoji buttons to ensure correct styling for selected/unselected states and update names
            generateEmojiButtons();
            updateSelectedEmojisDisplay(); // Ensure selected emojis are displayed after content update

            // Re-generate action step buttons to ensure correct styling and language
            generateActionStepButtons();
            updateSelectedActionStepsDisplay(); // Ensure selected action steps are displayed

            // Generate preset icon buttons for Visual Space
            generatePresetIconButtons();


            // Update language toggle button styling
            if (lang === 'en') {
                document.getElementById('lang-en').classList.add('bg-blue-500', 'text-white');
                document.getElementById('lang-en').classList.remove('bg-gray-300', 'text-gray-800');
                document.getElementById('lang-fr').classList.add('bg-gray-300', 'text-gray-800');
                document.getElementById('lang-fr').classList.remove('bg-blue-500', 'text-white');
            } else {
                document.getElementById('lang-fr').classList.add('bg-blue-500', 'text-white');
                document.getElementById('lang-fr').classList.remove('bg-gray-300', 'text-gray-800');
                document.getElementById('lang-en').classList.add('bg-gray-300', 'text-gray-800');
                document.getElementById('lang-en').classList.remove('bg-blue-500', 'text-white');
            }
        };

        // Event listener for when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize Canvas and its drawing functionality
            initializeCanvas();

            // Detect browser language preference for initial load
            const browserLang = navigator.language.split('-')[0];
            if (browserLang === 'fr') {
                currentLanguage = 'fr';
            }

            // Generate buttons and update all content based on the initial language
            generateEmojiButtons();
            generateActionStepButtons(); // Generate action step buttons on load
            generatePresetIconButtons(); // Generate preset icon buttons on load
            
            // Load today's entry initially
            loadEntry(currentDate);

            // Add event listeners for language toggle buttons
            document.getElementById('lang-en').addEventListener('click', () => {
                currentLanguage = 'en';
                updateContent('en');
            });

            document.getElementById('lang-fr').addEventListener('click', () => {
                currentLanguage = 'fr';
                updateContent('fr');
            });

            // Add event listeners for journal navigation and save
            document.getElementById('prev-day-btn').addEventListener('click', () => {
                const newDate = new Date(currentDate);
                newDate.setDate(newDate.getDate() - 1);
                loadEntry(newDate);
            });

            document.getElementById('next-day-btn').addEventListener('click', () => {
                const newDate = new Date(currentDate);
                newDate.setDate(newDate.getDate() + 1);
                loadEntry(newDate);
            });

            document.getElementById('save-entry-btn').addEventListener('click', saveEntry);
        });
    </script>
</body>
</html>
ÔøΩ
